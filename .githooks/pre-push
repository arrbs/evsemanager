#!/usr/bin/env bash
# Pre-push hook that enforces addon version bump when evse_manager/config.yaml has changed.
# To enable: git config core.hooksPath .githooks
set -euo pipefail

# Allow skipping hook by setting env var
if [ "$SKIP_VERSION_CHECK" = "1" ] 2>/dev/null; then
    exit 0
fi

# Determine remote ref to compare against
REMOTE_REF=origin/main

# Fetch remote silently
if ! git fetch --quiet origin main; then
    echo "[pre-push] Warning: could not fetch origin main - skipping version check" >&2
    exit 0
fi

# See if config has changed relative to remote
if git diff --name-only "$REMOTE_REF"...HEAD | grep -q '^evse_manager/config.yaml$'; then
    echo "[pre-push] Detected change to evse_manager/config.yaml - verifying version bump..."

    # Get old and new versions
    old_version=$(git show "$REMOTE_REF:evse_manager/config.yaml" 2>/dev/null | grep '^version:' | sed -E 's/version:[[:space:]]*"([^"]+)"/\1/' || echo "0.0.0")
    new_version=$(grep '^version:' evse_manager/config.yaml | sed -E 's/version:[[:space:]]*"([^"]+)"/\1/' || echo "0.0.0")

    if [ -z "$old_version" ]; then
        old_version="0.0.0"
    fi
    if [ -z "$new_version" ]; then
        new_version="0.0.0"
    fi

    compare_versions() {
        IFS=. read -r o1 o2 o3 <<<"$1"
        IFS=. read -r n1 n2 n3 <<<"$2"
        o1=${o1:-0}; o2=${o2:-0}; o3=${o3:-0}
        n1=${n1:-0}; n2=${n2:-0}; n3=${n3:-0}
        if (( n1 > o1 )); then
            return 0
        elif (( n1 < o1 )); then
            return 2
        fi
        if (( n2 > o2 )); then
            return 0
        elif (( n2 < o2 )); then
            return 2
        fi
        if (( n3 > o3 )); then
            return 0
        elif (( n3 < o3 )); then
            return 2
        fi
        return 1
    }

    compare_versions "$old_version" "$new_version"
    rc=$?
    if [ $rc -eq 0 ]; then
        echo "[pre-push] version bump ok: $old_version â†’ $new_version"
    elif [ $rc -eq 1 ]; then
        echo "[pre-push] ERROR: Version has not changed (still $old_version). Please bump evse_manager/config.yaml before pushing." >&2
        exit 1
    else
        echo "[pre-push] ERROR: New version ($new_version) must be greater than previous ($old_version)." >&2
        exit 1
    fi
else
    # no config change, nothing to do
    exit 0
fi
